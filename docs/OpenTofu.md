### Документация для работы с OpenTofu на Proxmox
Для автоматизации развертывания виртуальных машин мы будем использовать OpenTofu.
OpenTofu - это opensource форк Terraform со свободной лицензией. На данный момент они обратно совместимы. Если в какой то момент будет найдено расхождение, то на это будет указано. В данный момент мы можем использовать официальную документацию к terraform для работы с OpenTofu.
Данный инструмент позволяет нам работать с инфратруктурой как с кодом (IaC), что позволяет декларативно описывать требуемое состояние ресурсов. Это уменьшает количество ошибок при создании ресурсов, а так же помогает в их учете. Так же благодрая API используемых нами сервисов, мы можем сразу же интегрировать созданый нами ресурс в нашу инфраструктуру.
## Принцип работы OpenTofu
Для автоматизации работы с инфраструктурой OpenTofu использует собственный язык написания конфигурационных файлов разработаный Hashicorp Configuration Language (HCL). По сути, этот язык описывает желаемое состояние инфраструктуры в конфигурационном файле (или файлах) с расширением .tf
Работа с OpenTofu строится на четырех основных этапах: инициализация, валидация, планирование и применение изменений.
# Этап 1: Инициализация проекта
```
tofu init
```
Эта команда производит иницилизацию репозитория проекта, а именно скачивает указанные провайдеры. Если провайдеры уже скачаны, то проверяет новые версии и обновляет их.

# Этап 2: Валидация кода
```
tofu validate
```
Данная команда запускает автопроверку кода на соответствие синтаксису и наличие логических проблем. 
# Этап 3: Планирование изменений 
```
tofu plan
```
На этом этапе OpenTofu читает все файлы в директории с расширением .tf и создает общий файл стейта (state) с расширением .tfstate в котором содержится информация о планируемой архитектуре и выделенных ресурсах.
Содержимое данного файла он выводи в консоль. Если файл стейта уже существуе, то OpenTofu читает его и сравнивает с конфигурацией указанной в файлах .tf и выводит дифф (diff) в консоль. Нужно внимательно его изучать для избегания проблем
# Этап 4: Применение изменений 
```
tofu apply
```
Применяет указанные в стейт файле изменения, создавая или изменяя перечисленные ресурсы. Работа с ресурсами идет в асинхронном режим (т. е. паралельно) и может выполняться до 10 задач сразу. 
## Команды для использования данного репозитория
После проведения подготовки и заполнения всех значений требуется выполнить следующие команды.
Мы иницилизируем репозиторий. Скачиваем провайдеры или если они уже скачаны обновляем их.
```
tofu init
```

Валидируем наш репозиторий, проверяя что нет ошибок и всет нормально читаетсяю
```
tofu validate
```
Последовательно проходимся по всем файлам .tf и подставляем значения переменных из файла values.tfvars записывая предварительный результат в файл с именем vm.
```
tofu plan -var-file values.tfvars -out vm
```
опция -var-file указывает на файл с переменными в котором находятся все основные настройки ВМ.
опция -out создает файл в котором хранится вся прочитанная нами конфигурация с уже вставленными значениями переменных. Имя файла конфигурации может быть любым.

Мы применяем настройки указанные в файле, который создался после применения tofu plan.
Начинается создание виртуальной машины в зависимости от настроек которые мы указали.
```
tofu apply vm
```
После этого создается state файл который уже хранит итоговую конфигурацию всех ресурсов описаных в файлах. В любой момент времени к стейт файлу должен иметь доступ только один человек иначе пойдет рассинхрон конфигурации и все поломается. По этому нужно обеспечить надежное хранение данного файла.
Так как это файл хранит в себе всю конфигурациии, он так же  содержит секретные данный (ip, пароли). Доступ к данному файлу должен быть только у доверенных пользователей.
